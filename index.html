<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAY (THERE IS/ARE) TEST</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-section { display: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

    <!-- Navbar -->
    <nav class="bg-blue-800 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold uppercase">HAY (THERE IS/ARE) TEST</h1>
                <p class="text-xs text-blue-200">Spanish 1 • Intro to Existence</p>
            </div>
            <button onclick="window.toggleTeacherModal()" class="text-xs bg-blue-900 hover:bg-blue-700 px-3 py-1 rounded transition cursor-pointer">
                <i class="fas fa-lock mr-1"></i> Teacher Access
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto p-6">
        
        <!-- Student Login Form -->
        <div id="student-login" class="bg-white p-8 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">Student Identification</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-semibold mb-2">First Name</label>
                    <input type="text" id="fname" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter your first name">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Last Name</label>
                    <input type="text" id="lname" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter your last name">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Email Address</label>
                    <input type="email" id="email" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter your school email">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Period</label>
                    <select id="period" class="w-full p-3 border rounded-lg bg-white">
                        <option>1st</option>
                        <option>A2</option>
                        <option>A4</option>
                        <option>B3</option>
                        <option>B4</option>
                        <option>5th</option>
                    </select>
                </div>
            </div>
            <button onclick="startQuiz()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition transform hover:scale-[1.01]">
                Start Exam
            </button>
        </div>

        <!-- Quiz Container (Hidden initially) -->
        <div id="quiz-container" class="hidden-section fade-in">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-blue-50 p-4 border-b border-blue-100 flex justify-between items-center">
                    <span id="student-display" class="font-semibold text-blue-800"></span>
                    <span class="text-sm text-gray-500">50 Questions</span>
                </div>
                <div id="questions-list" class="p-6 space-y-8">
                    <!-- Questions injected via JS -->
                </div>
                <div class="p-6 bg-gray-50 border-t flex justify-center">
                    <button onclick="submitExam()" class="bg-green-600 hover:bg-green-700 text-white text-lg font-bold py-3 px-12 rounded-full shadow-lg transition transform hover:-translate-y-1">
                        Submit Exam
                    </button>
                </div>
            </div>
        </div>

        <!-- Result Section (Hidden initially) -->
        <div id="result-container" class="hidden-section fade-in text-center py-10">
            <div class="bg-white p-8 rounded-xl shadow-xl max-w-2xl mx-auto">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-3xl text-green-600"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Exam Completed!</h2>
                <p class="text-gray-600 mb-6">Your score has been recorded.</p>
                
                <div class="bg-gray-100 p-4 rounded-lg mb-8">
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Final Score</p>
                    <p id="final-score-display" class="text-5xl font-bold text-blue-900 mt-2">0%</p>
                </div>

                <!-- High Visibility Warning -->
                <div class="bg-red-600 border-4 border-red-800 p-6 rounded-xl text-center text-white mb-8 shadow-2xl">
                    <i class="fas fa-file-download text-5xl mb-4 text-yellow-300 animate-bounce"></i>
                    <h3 class="text-2xl font-black uppercase mb-4 tracking-wide border-b-2 border-red-400 pb-2">⚠ ACTION REQUIRED ⚠</h3>
                    <p class="text-xl font-bold leading-tight mb-2">
                        DOWNLOAD THE FILE AND SEND IT TO YOUR TEACHER!!!
                    </p>
                    <p class="text-lg">
                        Look for <code id="filename-display" class="bg-white text-red-600 px-2 py-1 rounded font-mono font-bold mx-1 text-base">result.csv</code> in your downloads folder.
                    </p>
                </div>

                <!-- Manual Download Button -->
                <div class="mb-6">
                    <p class="text-sm text-gray-500 mb-2">Did the file not download automatically?</p>
                    <button onclick="downloadResult(lastResultData)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition flex items-center justify-center mx-auto gap-2">
                        <i class="fas fa-download"></i> Download File Again
                    </button>
                </div>

                <div class="border-t pt-4">
                    <button onclick="location.reload()" class="text-blue-600 hover:text-blue-800 font-semibold underline">Start New Session</button>
                </div>
            </div>
        </div>

        <!-- Teacher Dashboard (Hidden) -->
        <div id="teacher-dashboard" class="hidden-section fade-in">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-chalkboard-teacher text-blue-600 mr-2"></i>Teacher Dashboard</h2>
                    <button onclick="logoutTeacher()" class="text-red-500 hover:text-red-700 font-medium">Logout</button>
                </div>

                <!-- Data Import -->
                <div class="bg-blue-50 border-2 border-dashed border-blue-300 rounded-xl p-8 text-center mb-8" ondragover="event.preventDefault()" ondrop="handleDrop(event)">
                    <i class="fas fa-cloud-upload-alt text-4xl text-blue-400 mb-3"></i>
                    <p class="font-semibold text-blue-900">Upload Student Results</p>
                    <p class="text-sm text-blue-600 mb-4">Drag & drop student <strong>.csv</strong> files here or click to select</p>
                    <input type="file" id="file-upload" multiple class="hidden" onchange="handleFiles(this.files)" accept=".csv">
                    <button onclick="document.getElementById('file-upload').click()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">Select Files</button>
                </div>

                <!-- Statistics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white border rounded-xl p-4 shadow-sm">
                        <p class="text-gray-500 text-sm">Total Students</p>
                        <p id="stat-count" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-white border rounded-xl p-4 shadow-sm">
                        <p class="text-gray-500 text-sm">Average Score</p>
                        <p id="stat-avg" class="text-3xl font-bold text-blue-600">0%</p>
                    </div>
                    <div class="bg-white border rounded-xl p-4 shadow-sm">
                        <p class="text-gray-500 text-sm">Highest Score</p>
                        <p id="stat-high" class="text-3xl font-bold text-green-600">0%</p>
                    </div>
                </div>

                <!-- Top 3 Missed -->
                <div class="bg-red-50 rounded-xl p-6 mb-8 border border-red-100">
                    <h3 class="text-lg font-bold text-red-800 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Top 3 Most Missed Questions</h3>
                    <div id="missed-questions-list" class="space-y-3">
                        <p class="text-gray-500 italic">Upload data to see insights.</p>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 border-b">
                                <th class="p-4 font-semibold text-gray-600">Name</th>
                                <th class="p-4 font-semibold text-gray-600">Period</th>
                                <th class="p-4 font-semibold text-gray-600">Score</th>
                                <th class="p-4 font-semibold text-gray-600">Missed</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <!-- Rows injected JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[100]">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-96">
            <h3 class="text-lg font-bold mb-4">Teacher Access</h3>
            <input type="password" id="teacher-pwd" class="w-full border p-2 rounded mb-4" placeholder="Enter Password">
            <p id="pwd-error" class="text-red-500 text-sm mb-2 hidden">Incorrect password</p>
            <div class="flex justify-end gap-2">
                <button onclick="toggleTeacherModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                <button onclick="verifyTeacher()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Login</button>
            </div>
        </div>
    </div>

<script>
// --- Configuration ---
const TEACHER_PASSWORD = "admin"; 

// --- Quiz Data (50 Questions) ---
const quizData = [
    // BASIC USAGE (1-10)
    { q: "How do you say 'There is a book'?", options: ["Es un libro", "Tiene un libro", "Hay un libro", "Está un libro"], a: 2 },
    { q: "How do you say 'There are two pens'?", options: ["Hay dos bolígrafos", "Son dos bolígrafos", "Tienen dos bolígrafos", "Están dos bolígrafos"], a: 0 },
    { q: "Translate: 'Hay una mesa.'", options: ["There is a table.", "This is a table.", "I have a table.", "Where is the table?"], a: 0 },
    { q: "Translate: 'Hay tres gatos.'", options: ["Three cats are here.", "There are three cats.", "I see three cats.", "The cats are three."], a: 1 },
    { q: "Does 'Hay' change form for plural nouns?", options: ["Yes (Hays)", "Yes (Han)", "No, it stays 'Hay'", "Yes (Hayn)"], a: 2 },
    { q: "How do you say 'Is there...?' in Spanish?", options: ["¿Es...?", "¿Hay...?", "¿Tiene...?", "¿Está...?"], a: 1 },
    { q: "True or False: 'Hay' can mean 'There is' AND 'There are'.", options: ["True", "False"], a: 0 },
    { q: "Select the correct sentence:", options: ["Hay un chicos.", "Hay un chico.", "Hay una chico.", "Hay unos chico."], a: 1 },
    { q: "Select the correct sentence:", options: ["Hay muchas flores.", "Hay muchos flores.", "Hay mucho flores.", "Hay una flores."], a: 0 },
    { q: "Translate: 'There is a problem.'", options: ["Hay un problema.", "Es un problema.", "Tiene problema.", "Está problema."], a: 0 },

    // CLASSROOM VOCABULARY (11-20)
    { q: "En la clase, ___ una pizarra.", options: ["hay", "es", "tiene", "está"], a: 0 },
    { q: "___ muchos estudiantes en la escuela.", options: ["Hay", "Son", "Tienen", "Están"], a: 0 },
    { q: "¿___ un lápiz en tu mochila?", options: ["Hay", "Es", "Tiene", "Son"], a: 0 },
    { q: "Translate: 'There are five chairs.'", options: ["Hay cinco sillas.", "Son cinco sillas.", "Tienen cinco sillas.", "Cinco sillas hay."], a: 0 },
    { q: "Translate: 'There is a map on the wall.'", options: ["Hay un mapa en la pared.", "Es un mapa en la pared.", "Tiene un mapa.", "Está un mapa."], a: 0 },
    { q: "How do you say 'There are no exams today'?", options: ["No hay exámenes hoy.", "No son exámenes hoy.", "No tienen exámenes.", "Nada exámenes hoy."], a: 0 },
    { q: "In the library, there are books. -> En la biblioteca ___ libros.", options: ["hay", "son", "están", "tienen"], a: 0 },
    { q: "___ una computadora en el escritorio.", options: ["Hay", "Es", "Tiene", "Son"], a: 0 },
    { q: "¿Cuántos días ___ en una semana?", options: ["hay", "son", "es", "tienen"], a: 0 },
    { q: "En mi clase de español ___ veinte alumnos.", options: ["hay", "son", "están", "tienen"], a: 0 },

    // NEGATIVES & QUANTITIES (21-30)
    { q: "How do you say 'There is nothing'?", options: ["No hay nada.", "No es nada.", "Hay no nada.", "Nada es."], a: 0 },
    { q: "Translate: 'No hay tarea.'", options: ["There is no homework.", "I don't have homework.", "Homework is not here.", "No working."], a: 0 },
    { q: "Complete: No ___ luz (light).", options: ["hay", "es", "tiene", "está"], a: 0 },
    { q: "Translate: 'Is there any water?'", options: ["¿Hay agua?", "¿Es agua?", "¿Tiene agua?", "¿Está agua?"], a: 0 },
    { q: "Complete: ___ mucha gente (people) aquí.", options: ["Hay", "Es", "Son", "Están"], a: 0 },
    { q: "Translate: 'There are few cars.'", options: ["Hay pocos carros.", "Hay muchos carros.", "Hay pequeños carros.", "Hay grandes carros."], a: 0 },
    { q: "How do you say 'There is nobody'?", options: ["No hay nadie.", "No hay alguien.", "No hay nada.", "No es nadie."], a: 0 },
    { q: "Translate: 'No hay tiempo.'", options: ["There is no time.", "It is not time.", "I don't have time.", "Time is not here."], a: 0 },
    { q: "Select the correct negative form:", options: ["No hay perros.", "Hay no perros.", "Not hay perros.", "No perros hay."], a: 0 },
    { q: "Translate: 'There are many questions.'", options: ["Hay muchas preguntas.", "Hay muchos preguntas.", "Hay mucha preguntas.", "Hay una preguntas."], a: 0 },

    // HOUSE & CITY CONTEXT (31-40)
    { q: "En mi casa ___ tres dormitorios.", options: ["hay", "son", "están", "tienen"], a: 0 },
    { q: "En la cocina ___ un refrigerador.", options: ["hay", "es", "está", "tiene"], a: 0 },
    { q: "¿___ un parque cerca de aquí?", options: ["Hay", "Es", "Está", "Tiene"], a: 0 },
    { q: "En la ciudad ___ muchos edificios altos.", options: ["hay", "son", "están", "tienen"], a: 0 },
    { q: "Translate: 'There is a dog in the garden.'", options: ["Hay un perro en el jardín.", "Es un perro en el jardín.", "Está un perro en el jardín.", "Tiene un perro."], a: 0 },
    { q: "Translate: 'There are flowers on the table.'", options: ["Hay flores en la mesa.", "Son flores en la mesa.", "Están flores en la mesa.", "Tienen flores."], a: 0 },
    { q: "¿Qué ___ en la sala?", options: ["hay", "es", "son", "tiene"], a: 0 },
    { q: "En el baño ___ una ducha.", options: ["hay", "es", "está", "tiene"], a: 0 },
    { q: "Translate: 'There is a big store.'", options: ["Hay una tienda grande.", "Es una tienda grande.", "Tiene una tienda grande.", "Está una tienda grande."], a: 0 },
    { q: "No ___ cine en este pueblo.", options: ["hay", "es", "está", "tiene"], a: 0 },

    // MIXED PRACTICE (41-50)
    { q: "¿___ un doctor en el hospital?", options: ["Hay", "Es", "Está", "Tiene"], a: 0 },
    { q: "Translate: 'There are two windows.'", options: ["Hay dos ventanas.", "Son dos ventanas.", "Dos ventanas son.", "Están dos ventanas."], a: 0 },
    { q: "Complete: ___ mucho ruido (noise).", options: ["Hay", "Es", "Tiene", "Está"], a: 0 },
    { q: "How do you say 'There is a lot of food'?", options: ["Hay mucha comida.", "Hay muchos comida.", "Hay muy comida.", "Es mucha comida."], a: 0 },
    { q: "Translate: 'No hay problema.'", options: ["There is no problem.", "It is not a problem.", "I don't have a problem.", "Problem is not."], a: 0 },
    { q: "¿Cuántas chicas ___ en el equipo?", options: ["hay", "son", "están", "tienen"], a: 0 },
    { q: "En el mundo ___ muchas personas.", options: ["hay", "son", "están", "tienen"], a: 0 },
    { q: "Translate: 'There is a spider!'", options: ["¡Hay una araña!", "¡Es una araña!", "¡Está una araña!", "¡Tiene una araña!"], a: 0 },
    { q: "Complete: En el cielo (sky) ___ nubes.", options: ["hay", "son", "están", "tienen"], a: 0 },
    { q: "Final Question: What does 'Hay' mean?", options: ["There is / There are", "To have", "To be", "To go"], a: 0 }
];

let studentData = {
    fname: "",
    lname: "",
    email: "",
    period: "",
    answers: [] 
};

let lastResultData = null;

// --- Student Flow ---

function startQuiz() {
    const f = document.getElementById('fname').value.trim();
    const l = document.getElementById('lname').value.trim();
    const e = document.getElementById('email').value.trim().toLowerCase();
    const p = document.getElementById('period').value;

    if (!f || !l || !e) {
        alert("Please enter your full name and email address.");
        return;
    }

    // Check for previous attempt using Email
    const uniqueId = `quiz_taken_${e}`;
    if (localStorage.getItem(uniqueId)) {
        alert("Access Denied: This email address has already submitted the exam.");
        return;
    }

    studentData.fname = f;
    studentData.lname = l;
    studentData.email = e;
    studentData.period = p;

    document.getElementById('student-display').innerText = `${l}, ${f} (${p})`;
    document.getElementById('student-login').classList.add('hidden-section');
    document.getElementById('quiz-container').classList.remove('hidden-section');

    renderQuestions();
}

function renderQuestions() {
    const container = document.getElementById('questions-list');
    container.innerHTML = quizData.map((q, index) => `
        <div class="mb-6 p-4 border rounded-lg hover:bg-gray-50 transition" id="q-box-${index}">
            <p class="font-semibold text-lg mb-3">${index + 1}. ${q.q}</p>
            <div class="space-y-2">
                ${q.options.map((opt, optIndex) => `
                    <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-blue-100 transition">
                        <input type="radio" name="q${index}" value="${optIndex}" class="form-radio h-5 w-5 text-blue-600">
                        <span>${opt}</span>
                    </label>
                `).join('')}
            </div>
        </div>
    `).join('');
}

function submitExam() {
    const answers = [];
    let score = 0;
    let missedIndices = [];

    for (let i = 0; i < quizData.length; i++) {
        const selected = document.querySelector(`input[name="q${i}"]:checked`);
        if (!selected) {
            alert(`You missed question ${i + 1}. Please answer all questions.`);
            document.getElementById(`q-box-${i}`).scrollIntoView({behavior: "smooth", block: "center"});
            return;
        }
        const val = parseInt(selected.value);
        answers.push(val);
        
        let isCorrect = false;
        if (Array.isArray(quizData[i].a)) {
            isCorrect = quizData[i].a.includes(val);
        } else {
            isCorrect = (val === quizData[i].a);
        }

        if (isCorrect) {
            score++;
        } else {
            missedIndices.push(i);
        }
    }

    // Mark exam as taken in localStorage using Email
    const uniqueId = `quiz_taken_${studentData.email}`;
    localStorage.setItem(uniqueId, "true");

    const finalScore = Math.round((score / quizData.length) * 100);
    const resultPayload = {
        name: `${studentData.lname}, ${studentData.fname}`,
        email: studentData.email,
        period: studentData.period,
        score: finalScore,
        rawScore: score,
        total: quizData.length,
        missed: missedIndices,
        timestamp: new Date().toISOString()
    };

    lastResultData = resultPayload;

    document.getElementById('quiz-container').classList.add('hidden-section');
    document.getElementById('result-container').classList.remove('hidden-section');
    document.getElementById('final-score-display').innerText = finalScore + "%";
    
    downloadResult(resultPayload);
}

function downloadResult(data) {
    if (!data) return; 
    
    // Updated Headers to include Email
    const headers = ["Name", "Email", "Period", "Score", "RawScore", "Total", "Timestamp", "MissedQuestionIndices"];
    const safeName = data.name.replace(/"/g, '""');
    const missedStr = data.missed.join('|');
    
    const row = [
        `"${safeName}"`,
        `"${data.email}"`,
        `"${data.period}"`,
        data.score,
        data.rawScore,
        data.total,
        `"${data.timestamp}"`,
        `"${missedStr}"`
    ];
    
    const csvContent = headers.join(",") + "\n" + row.join(",");
    const dataStr = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
    const downloadAnchorNode = document.createElement('a');
    const fileName = `Result_${studentData.lname.replace(/[^a-z0-9]/gi, '')}_${studentData.fname.replace(/[^a-z0-9]/gi, '')}.csv`;
    
    document.getElementById('filename-display').innerText = fileName;
    
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", fileName);
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

// --- Teacher Flow ---

function toggleTeacherModal() {
    const modal = document.getElementById('password-modal');
    modal.classList.toggle('hidden');
    document.getElementById('pwd-error').classList.add('hidden');
    document.getElementById('teacher-pwd').value = "";
}

function verifyTeacher() {
    const pwd = document.getElementById('teacher-pwd').value;
    if (pwd === TEACHER_PASSWORD) {
        toggleTeacherModal();
        document.getElementById('student-login').classList.add('hidden-section');
        document.getElementById('quiz-container').classList.add('hidden-section');
        document.getElementById('result-container').classList.add('hidden-section');
        document.getElementById('teacher-dashboard').classList.remove('hidden-section');
    } else {
        document.getElementById('pwd-error').classList.remove('hidden');
    }
}

function logoutTeacher() {
    location.reload();
}

window.toggleTeacherModal = toggleTeacherModal;
window.verifyTeacher = verifyTeacher;
window.logoutTeacher = logoutTeacher;

// --- Dashboard Logic ---

let classResults = [];

function handleDrop(e) {
    e.preventDefault();
    handleFiles(e.dataTransfer.files);
}

function handleFiles(files) {
    Array.from(files).forEach(file => {
        if (!file.name.toLowerCase().endsWith('.csv')) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const text = e.target.result;
                const lines = text.trim().split('\n');
                if (lines.length < 2) return; 
                
                const rowStr = lines[1];
                const matches = rowStr.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                
                // Updated check for new CSV format (Length 8)
                if (!matches || matches.length < 8) throw new Error("Invalid CSV Format");

                const clean = (str) => str ? str.replace(/^"|"$/g, '').replace(/""/g, '"') : "";

                const res = {
                    name: clean(matches[0]),
                    email: clean(matches[1]), // Capture Email
                    period: clean(matches[2]),
                    score: parseInt(matches[3]),
                    rawScore: parseInt(matches[4]),
                    total: parseInt(matches[5]),
                    timestamp: clean(matches[6]),
                    missed: clean(matches[7]).split('|').filter(s => s !== "").map(Number)
                };

                if(!classResults.some(r => r.name === res.name && r.timestamp === res.timestamp)) {
                    classResults.push(res);
                }
                updateDashboard();
            } catch (err) {
                console.error("Error parsing file:", file.name, err);
            }
        };
        reader.readAsText(file);
    });
}

function updateDashboard() {
    const totalStudents = classResults.length;
    const avgScore = Math.round(classResults.reduce((acc, curr) => acc + curr.score, 0) / totalStudents) || 0;
    const highScore = Math.max(...classResults.map(r => r.score), 0);

    document.getElementById('stat-count').innerText = totalStudents;
    document.getElementById('stat-avg').innerText = avgScore + "%";
    document.getElementById('stat-high').innerText = highScore + "%";

    const tbody = document.getElementById('results-table-body');
    tbody.innerHTML = classResults.map(r => `
        <tr class="border-b hover:bg-gray-50">
            <td class="p-3 font-medium">${r.name}</td>
            <td class="p-3 text-gray-500">${r.period}</td>
            <td class="p-3 font-bold ${getScoreColor(r.score)}">${r.score}%</td>
            <td class="p-3 text-xs text-gray-400">${r.missed.map(i => i+1).join(', ')}</td>
        </tr>
    `).join('');

    const questionMissCounts = {};
    classResults.forEach(r => {
        r.missed.forEach(qIdx => {
            if (!isNaN(qIdx)) {
                questionMissCounts[qIdx] = (questionMissCounts[qIdx] || 0) + 1;
            }
        });
    });

    const sortedMissed = Object.keys(questionMissCounts)
        .map(key => ({ 
            index: parseInt(key), 
            count: questionMissCounts[key], 
            text: quizData[key].q 
        }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 3);

    const missedContainer = document.getElementById('missed-questions-list');
    if (sortedMissed.length > 0) {
        missedContainer.innerHTML = sortedMissed.map(item => {
            const pct = Math.round((item.count / totalStudents) * 100);
            return `
                <div class="flex items-start bg-white p-3 rounded border shadow-sm">
                    <span class="bg-red-100 text-red-800 font-bold px-2 py-1 rounded text-xs mr-3">Q${item.index + 1}</span>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800">${item.text}</p>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            <div class="bg-red-500 h-2 rounded-full" style="width: ${pct}%"></div>
                        </div>
                        <p class="text-xs text-right text-red-600 mt-1">${pct}% of class missed this</p>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function getScoreColor(score) {
    if(score >= 90) return 'text-green-600';
    if(score >= 70) return 'text-yellow-600';
    return 'text-red-600';
}
</script>
</body>
</html>