<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAY (THERE IS/ARE) TEST</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-section { display: none; }
        
        /* Word Tile Styles */
        .word-tile {
            transition: all 0.2s;
            user-select: none;
            cursor: pointer;
            box-shadow: 0 2px 0 #cbd5e1; /* mimic 3d button */
            text-transform: lowercase; /* Visual enforcement */
        }
        .word-tile:active {
            transform: translateY(2px);
            box-shadow: none;
        }
        .answer-area:empty::before {
            content: 'Tap words below to build sentence...';
            color: #9ca3af;
            font-style: italic;
            font-size: 0.9rem;
            align-self: center;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

    <!-- Navbar -->
    <nav class="bg-blue-800 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold uppercase">HAY (THERE IS/ARE) TEST</h1>
                <p class="text-xs text-blue-200">Spanish 1 • Sentence Structure</p>
            </div>
            <button onclick="window.toggleTeacherModal()" class="text-xs bg-blue-900 hover:bg-blue-700 px-3 py-1 rounded transition cursor-pointer">
                <i class="fas fa-lock mr-1"></i> Teacher Access
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto p-6">
        
        <!-- Student Login Form -->
        <div id="student-login" class="bg-white p-8 rounded-xl shadow-lg fade-in">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">Student Identification</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-semibold mb-2">First Name</label>
                    <input type="text" id="fname" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter your first name">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Last Name</label>
                    <input type="text" id="lname" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter your last name">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Email Address</label>
                    <input type="email" id="email" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter your school email">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Period</label>
                    <select id="period" class="w-full p-3 border rounded-lg bg-white">
                        <option>1st</option>
                        <option>A2</option>
                        <option>A4</option>
                        <option>B3</option>
                        <option>B4</option>
                        <option>5th</option>
                    </select>
                </div>
            </div>
            <button onclick="startQuiz()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition transform hover:scale-[1.01]">
                Start Exam
            </button>
        </div>

        <!-- Quiz Container (Hidden initially) -->
        <div id="quiz-container" class="hidden-section fade-in">
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-blue-50 p-4 border-b border-blue-100 flex justify-between items-center">
                    <span id="student-display" class="font-semibold text-blue-800"></span>
                    <span class="text-sm text-gray-500">50 Questions</span>
                </div>
                
                <div class="bg-yellow-50 p-4 border-b border-yellow-100 text-sm text-yellow-800">
                    <i class="fas fa-info-circle mr-1"></i> 
                    <strong>Instructions:</strong> Tap words in the "Word Bank" to move them to the answer line. Arrange them to form the correct Spanish sentence. <span class="font-bold text-red-600">Note: Words are lowercase and punctuation is removed to increase difficulty.</span>
                </div>

                <div id="questions-list" class="p-6 space-y-10">
                    <!-- Questions injected via JS -->
                </div>
                <div class="p-6 bg-gray-50 border-t flex justify-center">
                    <button onclick="submitExam()" class="bg-green-600 hover:bg-green-700 text-white text-lg font-bold py-3 px-12 rounded-full shadow-lg transition transform hover:-translate-y-1">
                        Submit Exam
                    </button>
                </div>
            </div>
        </div>

        <!-- Result Section (Hidden initially) -->
        <div id="result-container" class="hidden-section fade-in text-center py-10">
            <div class="bg-white p-8 rounded-xl shadow-xl max-w-2xl mx-auto">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-3xl text-green-600"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Exam Completed!</h2>
                <p class="text-gray-600 mb-6">Your score has been recorded.</p>
                
                <div class="bg-gray-100 p-4 rounded-lg mb-8">
                    <p class="text-sm text-gray-500 uppercase tracking-wide">Final Score</p>
                    <p id="final-score-display" class="text-5xl font-bold text-blue-900 mt-2">0%</p>
                </div>

                <!-- High Visibility Warning -->
                <div class="bg-red-600 border-4 border-red-800 p-6 rounded-xl text-center text-white mb-8 shadow-2xl">
                    <i class="fas fa-file-download text-5xl mb-4 text-yellow-300 animate-bounce"></i>
                    <h3 class="text-2xl font-black uppercase mb-4 tracking-wide border-b-2 border-red-400 pb-2">⚠ ACTION REQUIRED ⚠</h3>
                    <p class="text-xl font-bold leading-tight mb-2">
                        DOWNLOAD THE FILE AND SEND IT TO YOUR TEACHER!!!
                    </p>
                    <p class="text-lg">
                        Look for <code id="filename-display" class="bg-white text-red-600 px-2 py-1 rounded font-mono font-bold mx-1 text-base">result.csv</code> in your downloads folder.
                    </p>
                </div>

                <!-- Manual Download Button -->
                <div class="mb-6">
                    <p class="text-sm text-gray-500 mb-2">Did the file not download automatically?</p>
                    <button onclick="downloadResult(lastResultData)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition flex items-center justify-center mx-auto gap-2">
                        <i class="fas fa-download"></i> Download File Again
                    </button>
                </div>

                <div class="border-t pt-4">
                    <button onclick="location.reload()" class="text-blue-600 hover:text-blue-800 font-semibold underline">Start New Session</button>
                </div>
            </div>
        </div>

        <!-- Teacher Dashboard (Hidden) -->
        <div id="teacher-dashboard" class="hidden-section fade-in">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-2xl font-bold text-gray-800"><i class="fas fa-chalkboard-teacher text-blue-600 mr-2"></i>Teacher Dashboard</h2>
                    <button onclick="logoutTeacher()" class="text-red-500 hover:text-red-700 font-medium">Logout</button>
                </div>

                <!-- Data Import -->
                <div class="bg-blue-50 border-2 border-dashed border-blue-300 rounded-xl p-8 text-center mb-8" ondragover="event.preventDefault()" ondrop="handleDrop(event)">
                    <i class="fas fa-cloud-upload-alt text-4xl text-blue-400 mb-3"></i>
                    <p class="font-semibold text-blue-900">Upload Student Results</p>
                    <p class="text-sm text-blue-600 mb-4">Drag & drop student <strong>.csv</strong> files here or click to select</p>
                    <input type="file" id="file-upload" multiple class="hidden" onchange="handleFiles(this.files)" accept=".csv">
                    <button onclick="document.getElementById('file-upload').click()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">Select Files</button>
                </div>

                <!-- Statistics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white border rounded-xl p-4 shadow-sm">
                        <p class="text-gray-500 text-sm">Total Students</p>
                        <p id="stat-count" class="text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="bg-white border rounded-xl p-4 shadow-sm">
                        <p class="text-gray-500 text-sm">Average Score</p>
                        <p id="stat-avg" class="text-3xl font-bold text-blue-600">0%</p>
                    </div>
                    <div class="bg-white border rounded-xl p-4 shadow-sm">
                        <p class="text-gray-500 text-sm">Highest Score</p>
                        <p id="stat-high" class="text-3xl font-bold text-green-600">0%</p>
                    </div>
                </div>

                <!-- Top 3 Missed -->
                <div class="bg-red-50 rounded-xl p-6 mb-8 border border-red-100">
                    <h3 class="text-lg font-bold text-red-800 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Top 3 Most Missed Questions</h3>
                    <div id="missed-questions-list" class="space-y-3">
                        <p class="text-gray-500 italic">Upload data to see insights.</p>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 border-b">
                                <th class="p-4 font-semibold text-gray-600">Name</th>
                                <th class="p-4 font-semibold text-gray-600">Period</th>
                                <th class="p-4 font-semibold text-gray-600">Score</th>
                                <th class="p-4 font-semibold text-gray-600">Missed</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <!-- Rows injected JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-[100]">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-96">
            <h3 class="text-lg font-bold mb-4">Teacher Access</h3>
            <input type="password" id="teacher-pwd" class="w-full border p-2 rounded mb-4" placeholder="Enter Password">
            <p id="pwd-error" class="text-red-500 text-sm mb-2 hidden">Incorrect password</p>
            <div class="flex justify-end gap-2">
                <button onclick="toggleTeacherModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                <button onclick="verifyTeacher()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Login</button>
            </div>
        </div>
    </div>

<script>
// --- Configuration ---
const TEACHER_PASSWORD = "admin"; 

// --- Sentence Building Data (50 Questions) ---
// Keys: 'eng' (Prompt), 'span' (Correct Sentence), 'distractor' (Extra wrong word)
const rawQuizData = [
    // Basic Usage
    { eng: "There is a book.", span: "Hay un libro.", distractor: "Es" },
    { eng: "There are two pens.", span: "Hay dos bolígrafos.", distractor: "Son" },
    { eng: "There is a table.", span: "Hay una mesa.", distractor: "Tiene" },
    { eng: "There are three cats.", span: "Hay tres gatos.", distractor: "Están" },
    { eng: "Is there a problem?", span: "¿ Hay un problema ?", distractor: "Es" },
    { eng: "Is there homework?", span: "¿ Hay tarea ?", distractor: "Tiene" },
    { eng: "There is a student (male).", span: "Hay un estudiante.", distractor: "El" },
    { eng: "There are some boys.", span: "Hay unos chicos.", distractor: "Son" },
    { eng: "There are many flowers.", span: "Hay muchas flores.", distractor: "Tienen" },
    { eng: "There is a problem.", span: "Hay un problema.", distractor: "Es" },

    // Classroom
    { eng: "In the class, there is a whiteboard.", span: "En la clase, hay una pizarra.", distractor: "Es" },
    { eng: "There are many students in the school.", span: "Hay muchos estudiantes en la escuela.", distractor: "Son" },
    { eng: "Is there a pencil in your backpack?", span: "¿ Hay un lápiz en tu mochila ?", distractor: "Tiene" },
    { eng: "There are five chairs.", span: "Hay cinco sillas.", distractor: "Son" },
    { eng: "There is a map on the wall.", span: "Hay un mapa en la pared.", distractor: "Está" },
    { eng: "There are no exams today.", span: "No hay exámenes hoy.", distractor: "Son" },
    { eng: "In the library, there are books.", span: "En la biblioteca hay libros.", distractor: "Tienen" },
    { eng: "There is a computer on the desk.", span: "Hay una computadora en el escritorio.", distractor: "Es" },
    { eng: "How many days are there in a week?", span: "¿ Cuántos días hay en una semana ?", distractor: "Son" },
    { eng: "In my class, there are twenty students.", span: "En mi clase hay veinte alumnos.", distractor: "Están" },

    // Negatives & Quantities
    { eng: "There is nothing.", span: "No hay nada.", distractor: "Es" },
    { eng: "There is no homework.", span: "No hay tarea.", distractor: "Tiene" },
    { eng: "There is no light.", span: "No hay luz.", distractor: "Está" },
    { eng: "Is there any water?", span: "¿ Hay agua ?", distractor: "Es" },
    { eng: "There are many people here.", span: "Hay mucha gente aquí.", distractor: "Son" },
    { eng: "There are few cars.", span: "Hay pocos carros.", distractor: "Tienen" },
    { eng: "There is nobody.", span: "No hay nadie.", distractor: "Es" },
    { eng: "There is no time.", span: "No hay tiempo.", distractor: "Tiene" },
    { eng: "There are no dogs.", span: "No hay perros.", distractor: "Son" },
    { eng: "There are many questions.", span: "Hay muchas preguntas.", distractor: "Tienen" },

    // House & City
    { eng: "In my house, there are three bedrooms.", span: "En mi casa hay tres dormitorios.", distractor: "Son" },
    { eng: "In the kitchen, there is a refrigerator.", span: "En la cocina hay un refrigerador.", distractor: "Está" },
    { eng: "Is there a park near here?", span: "¿ Hay un parque cerca ?", distractor: "Es" },
    { eng: "In the city, there are many buildings.", span: "En la ciudad hay muchos edificios.", distractor: "Son" },
    { eng: "There is a dog in the garden.", span: "Hay un perro en el jardín.", distractor: "Está" },
    { eng: "There are flowers on the table.", span: "Hay flores en la mesa.", distractor: "Son" },
    { eng: "What is there in the living room?", span: "¿ Qué hay en la sala ?", distractor: "Es" },
    { eng: "In the bathroom, there is a shower.", span: "En el baño hay una ducha.", distractor: "Tiene" },
    { eng: "There is a big store.", span: "Hay una tienda grande.", distractor: "Es" },
    { eng: "There is no movie theater in this town.", span: "No hay cine en este pueblo.", distractor: "Está" },

    // Mixed
    { eng: "Is there a doctor in the hospital?", span: "¿ Hay un doctor en el hospital ?", distractor: "Es" },
    { eng: "There are two windows.", span: "Hay dos ventanas.", distractor: "Son" },
    { eng: "There is a lot of noise.", span: "Hay mucho ruido.", distractor: "Es" },
    { eng: "There is a lot of food.", span: "Hay mucha comida.", distractor: "Tiene" },
    { eng: "There is no problem.", span: "No hay problema.", distractor: "Es" },
    { eng: "How many girls are there on the team?", span: "¿ Cuántas chicas hay en el equipo ?", distractor: "Son" },
    { eng: "In the world, there are many people.", span: "En el mundo hay muchas personas.", distractor: "Tienen" },
    { eng: "There is a spider!", span: "¡ Hay una araña !", distractor: "Es" },
    { eng: "In the sky, there are clouds.", span: "En el cielo hay nubes.", distractor: "Son" },
    { eng: "There is a cat under the table.", span: "Hay un gato debajo de la mesa.", distractor: "Está" }
];

let studentData = { fname: "", lname: "", email: "", period: "", answers: [] };
let lastResultData = null;
let currentSessionQuiz = []; // Holds randomized question objects with word shuffling state

// --- Helper Functions ---
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// Helper to normalize strings (Remove punctuation, lowercase)
function normalizeToken(str) {
    // Convert to lowercase
    // Remove periods (.) and commas (,) to reduce position hints
    // KEEP question marks (?¿) and exclamation points (!¡) as requested
    return str.toLowerCase().replace(/[.,]/g, "").trim();
}

// --- Student Flow ---

function startQuiz() {
    const f = document.getElementById('fname').value.trim();
    const l = document.getElementById('lname').value.trim();
    const e = document.getElementById('email').value.trim().toLowerCase();
    const p = document.getElementById('period').value;

    if (!f || !l || !e) { alert("Please enter your full name and email address."); return; }

    // Check for previous attempt using Email
    const uniqueId = `quiz_taken_${e}`;
    if (localStorage.getItem(uniqueId)) {
        alert("Access Denied: This email address has already submitted the exam.");
        return;
    }

    studentData.fname = f;
    studentData.lname = l;
    studentData.email = e;
    studentData.period = p;

    // --- Prepare Randomized Quiz ---
    // 1. Process raw data into playable objects
    let processedData = rawQuizData.map((item, index) => {
        // Split sentence by spaces to get tokens
        const rawTokens = item.span.split(' ').filter(t => t.length > 0);
        
        // Normalize correct tokens for the "Answer Key"
        // This removes punctuation from the logic check and lowercases everything
        const correctTokens = rawTokens.map(normalizeToken).filter(t => t.length > 0);
        
        // Normalize distractor
        const cleanDistractor = normalizeToken(item.distractor);

        // Create pool of words (correct + distractor), all normalized
        const allWords = [...correctTokens, cleanDistractor];
        
        // Create unique objects for each word
        const wordObjects = allWords.map((word, wIndex) => ({
            id: `q${index}_w${wIndex}`,
            text: word
        }));

        return {
            originalIndex: index,
            question: item.eng,
            correctOrder: correctTokens.join(' '), // The target string (lowercase, no punctuation)
            words: shuffleArray([...wordObjects]) // Shuffled bank
        };
    });

    // 2. Shuffle the Questions Order
    currentSessionQuiz = shuffleArray(processedData);

    document.getElementById('student-display').innerText = `${l}, ${f} (${p})`;
    document.getElementById('student-login').classList.add('hidden-section');
    document.getElementById('quiz-container').classList.remove('hidden-section');

    renderQuestions();
}

function renderQuestions() {
    const container = document.getElementById('questions-list');
    
    container.innerHTML = currentSessionQuiz.map((q, qIdx) => `
        <div class="mb-8 p-6 bg-white border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition" id="q-container-${qIdx}">
            <div class="mb-4">
                <span class="inline-block bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded mb-2">Question ${qIdx + 1}</span>
                <p class="text-xl font-semibold text-gray-800">Translate: <span class="text-blue-700 italic">"${q.question}"</span></p>
            </div>
            
            <!-- Answer Area (Drop Zone) -->
            <div id="answer-area-${qIdx}" class="answer-area min-h-[60px] bg-blue-50 border-2 border-dashed border-blue-200 rounded-lg p-3 flex flex-wrap gap-2 mb-4 transition-colors hover:border-blue-400">
                <!-- Words moved here will appear here -->
            </div>

            <!-- Word Bank -->
            <div id="word-bank-${qIdx}" class="flex flex-wrap gap-2 p-2">
                ${q.words.map(word => `
                    <button 
                        id="${word.id}" 
                        onclick="toggleWord('${qIdx}', '${word.id}', '${word.text}')" 
                        class="word-tile bg-white border border-gray-300 text-gray-700 font-medium px-4 py-2 rounded-lg shadow-sm hover:bg-gray-50 active:scale-95"
                    >
                        ${word.text}
                    </button>
                `).join('')}
            </div>
        </div>
    `).join('');
}

// Moves word between Bank and Answer Area
window.toggleWord = function(qIdx, wordId, wordText) {
    const btn = document.getElementById(wordId);
    const bank = document.getElementById(`word-bank-${qIdx}`);
    const answer = document.getElementById(`answer-area-${qIdx}`);
    
    if (btn.parentNode === bank) {
        // Move to Answer
        answer.appendChild(btn);
        btn.classList.replace('bg-white', 'bg-blue-600');
        btn.classList.replace('text-gray-700', 'text-white');
        btn.classList.replace('border-gray-300', 'border-blue-600');
    } else {
        // Move back to Bank
        bank.appendChild(btn);
        btn.classList.replace('bg-blue-600', 'bg-white');
        btn.classList.replace('text-white', 'text-gray-700');
        btn.classList.replace('border-blue-600', 'border-gray-300');
    }
};

function submitExam() {
    let score = 0;
    let missedIndices = [];

    // Evaluate each question
    currentSessionQuiz.forEach((q, idx) => {
        const answerArea = document.getElementById(`answer-area-${idx}`);
        const selectedButtons = Array.from(answerArea.children);
        
        // Reconstruct sentence from button text
        const studentSentence = selectedButtons.map(btn => btn.innerText.trim()).join(' ');
        
        // Compare with correct sentence (normalized in startQuiz)
        if (studentSentence === q.correctOrder) {
            score++;
        } else {
            missedIndices.push(q.originalIndex);
        }
    });

    // Mark exam as taken
    const uniqueId = `quiz_taken_${studentData.email}`;
    localStorage.setItem(uniqueId, "true");

    const finalScore = Math.round((score / currentSessionQuiz.length) * 100);
    const resultPayload = {
        name: `${studentData.lname}, ${studentData.fname}`,
        email: studentData.email,
        period: studentData.period,
        score: finalScore,
        rawScore: score,
        total: currentSessionQuiz.length,
        missed: missedIndices,
        timestamp: new Date().toISOString()
    };

    lastResultData = resultPayload;

    document.getElementById('quiz-container').classList.add('hidden-section');
    document.getElementById('result-container').classList.remove('hidden-section');
    document.getElementById('final-score-display').innerText = finalScore + "%";
    
    downloadResult(resultPayload);
}

function downloadResult(data) {
    if (!data) return; 
    
    const headers = ["Name", "Email", "Period", "Score", "RawScore", "Total", "Timestamp", "MissedQuestionIndices"];
    const safeName = data.name.replace(/"/g, '""');
    const missedStr = data.missed.join('|');
    
    const row = [
        `"${safeName}"`,
        `"${data.email}"`,
        `"${data.period}"`,
        data.score,
        data.rawScore,
        data.total,
        `"${data.timestamp}"`,
        `"${missedStr}"`
    ];
    
    const csvContent = headers.join(",") + "\n" + row.join(",");
    const dataStr = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
    const downloadAnchorNode = document.createElement('a');
    const fileName = `Result_${studentData.lname.replace(/[^a-z0-9]/gi, '')}_${studentData.fname.replace(/[^a-z0-9]/gi, '')}.csv`;
    
    document.getElementById('filename-display').innerText = fileName;
    
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", fileName);
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
}

// --- Teacher Flow ---

function toggleTeacherModal() {
    const modal = document.getElementById('password-modal');
    modal.classList.toggle('hidden');
    document.getElementById('pwd-error').classList.add('hidden');
    document.getElementById('teacher-pwd').value = "";
}

function verifyTeacher() {
    const pwd = document.getElementById('teacher-pwd').value;
    if (pwd === TEACHER_PASSWORD) {
        toggleTeacherModal();
        document.getElementById('student-login').classList.add('hidden-section');
        document.getElementById('quiz-container').classList.add('hidden-section');
        document.getElementById('result-container').classList.add('hidden-section');
        document.getElementById('teacher-dashboard').classList.remove('hidden-section');
    } else {
        document.getElementById('pwd-error').classList.remove('hidden');
    }
}

function logoutTeacher() {
    location.reload();
}

window.toggleTeacherModal = toggleTeacherModal;
window.verifyTeacher = verifyTeacher;
window.logoutTeacher = logoutTeacher;

// --- Dashboard Logic ---

let classResults = [];

function handleDrop(e) {
    e.preventDefault();
    handleFiles(e.dataTransfer.files);
}

function handleFiles(files) {
    Array.from(files).forEach(file => {
        if (!file.name.toLowerCase().endsWith('.csv')) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const text = e.target.result;
                const lines = text.trim().split('\n');
                if (lines.length < 2) return; 
                
                const rowStr = lines[1];
                const matches = rowStr.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                
                if (!matches || matches.length < 8) throw new Error("Invalid CSV Format");

                const clean = (str) => str ? str.replace(/^"|"$/g, '').replace(/""/g, '"') : "";

                const res = {
                    name: clean(matches[0]),
                    email: clean(matches[1]),
                    period: clean(matches[2]),
                    score: parseInt(matches[3]),
                    rawScore: parseInt(matches[4]),
                    total: parseInt(matches[5]),
                    timestamp: clean(matches[6]),
                    missed: clean(matches[7]).split('|').filter(s => s !== "").map(Number)
                };

                if(!classResults.some(r => r.name === res.name && r.timestamp === res.timestamp)) {
                    classResults.push(res);
                }
                updateDashboard();
            } catch (err) {
                console.error("Error parsing file:", file.name, err);
            }
        };
        reader.readAsText(file);
    });
}

function updateDashboard() {
    const totalStudents = classResults.length;
    const avgScore = Math.round(classResults.reduce((acc, curr) => acc + curr.score, 0) / totalStudents) || 0;
    const highScore = Math.max(...classResults.map(r => r.score), 0);

    document.getElementById('stat-count').innerText = totalStudents;
    document.getElementById('stat-avg').innerText = avgScore + "%";
    document.getElementById('stat-high').innerText = highScore + "%";

    const tbody = document.getElementById('results-table-body');
    tbody.innerHTML = classResults.map(r => `
        <tr class="border-b hover:bg-gray-50">
            <td class="p-3 font-medium">${r.name}</td>
            <td class="p-3 text-gray-500">${r.period}</td>
            <td class="p-3 font-bold ${getScoreColor(r.score)}">${r.score}%</td>
            <td class="p-3 text-xs text-gray-400">${r.missed.map(i => i+1).join(', ')}</td>
        </tr>
    `).join('');

    const questionMissCounts = {};
    classResults.forEach(r => {
        r.missed.forEach(qIdx => {
            if (!isNaN(qIdx)) {
                questionMissCounts[qIdx] = (questionMissCounts[qIdx] || 0) + 1;
            }
        });
    });

    const sortedMissed = Object.keys(questionMissCounts)
        .map(key => ({ 
            index: parseInt(key), 
            count: questionMissCounts[key], 
            text: rawQuizData[key].eng // Display the prompt Question 
        }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 3);

    const missedContainer = document.getElementById('missed-questions-list');
    if (sortedMissed.length > 0) {
        missedContainer.innerHTML = sortedMissed.map(item => {
            const pct = Math.round((item.count / totalStudents) * 100);
            return `
                <div class="flex items-start bg-white p-3 rounded border shadow-sm">
                    <span class="bg-red-100 text-red-800 font-bold px-2 py-1 rounded text-xs mr-3">Q${item.index + 1}</span>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800">${item.text}</p>
                        <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            <div class="bg-red-500 h-2 rounded-full" style="width: ${pct}%"></div>
                        </div>
                        <p class="text-xs text-right text-red-600 mt-1">${pct}% of class missed this</p>
                    </div>
                </div>
            `;
        }).join('');
    }
}

function getScoreColor(score) {
    if(score >= 90) return 'text-green-600';
    if(score >= 70) return 'text-yellow-600';
    return 'text-red-600';
}
</script>
</body>
</html>
